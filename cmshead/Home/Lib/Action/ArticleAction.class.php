<?php//前台文章管理class ArticleAction extends CommonAction {    //列表    public function index($id = 0) {        $id = $id ? $id : $_GET['id'];        if (!is_numeric($id))            $this->error('参数错误！');        $type = D('Category')->where('status=1')->find($id);        $type or $this->error('没有这个分类！');        $type['method'] = __FUNCTION__; //固定的        $map = D('Common')->getCategoryMap($id);        $map['status'] = array('eq', 1);        //分页取数据        import("ORG.Util.Page");        $Article = D("Article");        $count = $Article->where($map)->count();        $Page = new Page($count, 8);        $show = $Page->show();        $list = $Article->where($map)->order('(sort * 10 + add_time) DESC')->limit($Page->firstRow . ',' . $Page->listRows)->select();        foreach ($list as $key => $val) {            $val['method'] = 'Article/view';            $list[$key] = $this->changurl($val);        }        //赋值给模板        $this->assign('list', $list);        $this->assign('page', $show);        $this->seo($type['title'], $type['keywords'], $type['description'], D('Common')->getPosition($id));        $this->choosetpl($type);    }    //查看文章详细信息    public function view($id = 0) {        $id = $id ? $id : $_GET['id'];        if (!is_numeric($id))            $this->error('参数错误！');        $status = (false !== strpos($_SERVER['HTTP_REFERER'], C('CMSHEAD_URL') . '/admin.php')) ? '' : ' AND status=1'; //后台预览无需条件        D('Article')->where("id=$id{$status}")->setInc('apv'); //浏览量        $info = D('Article')->where("id=$id{$status}")->find();        $info or $this->error('没有这条记录！');        $info['method'] = __FUNCTION__; //固定的        $tmp = D('Category')->where('id in (' . $info['tid'] . ')')->field('module,newstemplate as template')->find();        $info = array_merge($tmp, $info); //自定义模板：文章模板优先，其次是分类模板。最后是默认模板        $this->assign('info', $info);        $this->seo($info['title'], $info['keywords'], strip_tags($info['description']), D('Common')->getPosition($info['tid']));        $art_pre = D('Article')->where("id<$id AND status=1")->order('id DESC')->field('id,title,apv')->find();        $art_pre['method'] = 'Article/view';        $art_pre = $this->changurl($art_pre);        $this->assign('art_pre', $art_pre); //上一篇        $art_next = D('Article')->where("id>$id AND status=1")->order('id')->field('id,title,apv')->find();        $art_next['method'] = 'Article/view';        $art_next = $this->changurl($art_next);        $this->assign('art_next', $art_next); //下一篇        $art_rand = D('Article')->where("status=1")->order('rand()')->limit(8)->select();        foreach ($art_rand as $key => $val) {            $val['method'] = 'Article/view';            $art_rand[$key] = $this->changurl($val);        }        $this->assign('art_rand', $art_rand); //随机8篇        $message = D('Message')->where("aid=$id AND status=1 AND pid=0")->select();        if (is_array($message)) {            foreach ($message as $key => $val) {                $message[$key] = $this->msgmodify($val);                $message[$key]['reply'] = D('Message')->where('status=1 AND pid=' . $val['id'])->select();                foreach ($message[$key]['reply'] as $key2 => $val2) {                    $message[$key]['reply'][$key2] = $this->msgmodify($val2);                }            }        }        $this->assign('msg_list', $message); //评论        $this->choosetpl($info);    }}