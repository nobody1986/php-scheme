<?php/* 前台动作基类 */class CommonAction extends Action {    //初始化    function _initialize() {        Load('extend');        //导航数据组装        $nav_list = D('Category')->where('pid=0 AND status=1')->order('sort DESC')->select();        if (is_array($nav_list)) {            foreach ($nav_list as $key => $val) {                $val['method'] = $val['module'] . '/index';                $nav_list[$key] = $this->changurl($val);                $nav_list[$key]['sub_nav'] = D('Category')->where('pid=' . $val['id'] . ' AND status=1')->select();                foreach ($nav_list[$key]['sub_nav'] as $key2 => $val2) {                    $val2['method'] = $val2['module'] . '/index';                    $nav_list[$key]['sub_nav'][$key2] = $this->changurl($val2);                }            }        }        //最热文章数据组装        $hot_art = D('Article')->where('status=1')->order('apv DESC')->limit(8)->select();        if (is_array($hot_art)) {            foreach ($hot_art as $key => $val) {                $val['method'] = 'Article/view';                $hot_art[$key] = $this->changurl($val);            }        }        $this->assign('hot_art', $hot_art);        //最热文章数据组装        $new_art = D('Article')->where('status=1')->order('add_time DESC')->limit(8)->select();        if (is_array($new_art)) {            foreach ($new_art as $key => $val) {                $val['method'] = 'Article/view';                $new_art[$key] = $this->changurl($val);            }        }        $this->assign('new_art', $new_art);        //最新留言        $new_leave = D('Message')->where('status=1 AND pid=0 AND aid=0')->order('add_time DESC')->limit(5)->select();        foreach ($new_leave as $key => $val) {            $new_leave[$key] = $this->msgmodify($val);        }        $this->assign('new_leave', $new_leave);        //最新评论        $new_comment = D('Message')->where('status=1 AND pid=0 AND aid!=0')->order('add_time DESC')->limit(5)->select();        foreach ($new_comment as $key => $val) {            $new_comment[$key] = $this->msgmodify($val);        }        $this->assign('new_comment', $new_comment);        $this->assign('link', D('Link')->where('status=1')->order('sort DESC')->limit(8)->select());        $this->assign('nav_list', $nav_list);    }    //验证码    public function verify() {        $type = isset($_GET['type']) ? $_GET['type'] : 'gif';        import("ORG.Util.Image");        Image::buildImageVerify(4, 1, $type);    }    //SEO赋值    public function seo($title, $keywords, $description, $positioin) {        $this->assign('title', $title);        $this->assign('keywords', $keywords);        $this->assign('description', $description);        $this->assign('position', $positioin);    }    /**     * URL转换     * 需要参数rewrite或Article/view     */    public function changurl($ary) {        if (is_array($ary)) {            if ($ary['rewrite']) {                                switch($ary['method']){                    case 'Article/view':                        $ary['url'] = '__APP__/topic/' . $ary['rewrite'];                        break;                    case 'Article/index':                        $ary['url'] = '__APP__/node/' . $ary['title'];                        break;                    default:                        $ary['url'] = '__APP__/' . $ary['rewrite'];                }            } elseif ($ary['method']) {                    $ary['url'] = '__APP__/' . ucfirst(strtolower($ary['method'])) . '/id/' . $ary['id'];            }        }        return $ary;    }    /**     * 模板选择     * 格式：template -> Article:index 对应 Tpl/Article/index.html     * 格式：template -> abc.html 对应 Tpl/Article/abc.html     * 需要的参数 template [module,method]     */    public function choosetpl($ary) {        $strtpl = 'article:view';        if (is_array($ary)) {            if (false !== strpos($ary['template'], ':')) {                $exp = explode(':', $ary['template']);                $file = $_SERVER['DOCUMENT_ROOT'] . APP_TMPL_PATH . $exp[0] . '/' . $exp[1] . '.html';                $t = @is_file($file);            }            if ($t) {                $strtpl = $ary['template'];            } else {                $module = $ary['module'] ? $ary['module'] : MODULE_NAME;                if ($ary['template'] != '') {                    if (false !== strpos($ary['template'], '/')) {                        $strtpl = str_replace(array('{tplroot}', '//'), array($_SERVER['DOCUMENT_ROOT'] . APP_TMPL_PATH, '/'), $ary['template']);                    } else {                        $strtpl = $_SERVER['DOCUMENT_ROOT'] . APP_TMPL_PATH . $module . '/' . (false !== strpos($ary['template'], '.') ? $ary['template'] : $ary['template'] . '.html');                    }                } elseif (isset($ary['method'])) {                    $strtpl = ($module . ':' . $ary['method']);                }            }        }        $this->display($strtpl);    }    //文件下载    public function download() {        $filename = $_SERVER[DOCUMENT_ROOT] . __ROOT__ . '/Public/Upload/download/' . $_GET['filename'];        header("Content-type: application/octet-stream");        header("Content-Length: " . filesize($filename));        header("Content-Disposition: attachment; filename={$_GET['filename']}");        $fp = fopen($filename, 'rb');        fpassthru($fp);        fclose($fp);    }    //留言评论信息处理    public function msgmodify($ary) {        if (is_array($ary)) {            if ($ary['adder_id'])                $ary['adder_name'] = getUserName($ary['adder_id']);            $ary['adder_email'] = md5($ary['adder_email']);        }        return $ary;    }    //空操作    public function _empty() {        $this->redirect("/");    }}